{% extends "base.html" %}
{% load static %}

{% block title %}Top{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/top.css' %}">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
{% endblock %}

{% block content %}

<!-- ヘッダー -->
<header class="app-header">
  <span></span>

  <h1 class="header-title">TIKAMITI</h1>

  <a href="/menu/" class="header-btn right">
    <span class="material-icons">menu</span>
  </a>
</header>

<!-- スクロール領域 -->
<div class="scroll-area">

  <!-- マップ -->
  <section class="map-section">
    <div class="map-dummy" id="map">

      <div class="map-overlay"></div>

      <svg class="route-svg">
        <polyline id="route-line"></polyline>
      </svg>

      <div class="you" id="you">現在地</div>

      <button class="store-pin gotanda"
              data-name="五反田店"
              data-distance="徒歩3分"
              data-meters="240"
              data-available="{{ available_map.五反田店 }}">
        <span class="material-icons">home</span>
      </button>

      <button class="store-pin meguro"
              data-name="目黒店"
              data-distance="徒歩15分"
              data-meters="1200"
              data-available="{{ available_map.目黒店 }}">
        <span class="material-icons">home</span>
      </button>

      <button class="store-pin osaki"
              data-name="大崎店"
              data-distance="徒歩9分"
              data-meters="720"
              data-available="{{ available_map.大崎店 }}">
        <span class="material-icons">home</span>
      </button>

    </div>

    <p class="map-note">
      店舗ピンをタップすると徒歩ルートが表示されます
    </p>
  </section>

  <!-- 店舗情報 -->
  <section class="card">
    <span class="label">ここから近い店舗</span>

    <h2 id="store-name">店舗を選択してください</h2>

    <div class="store-meta">
      <p id="store-distance">—</p>
      <span class="available-badge" id="store-available">—</span>
    </div>

    <div class="btn-group">
      <a href="/machines/" class="btn primary">マシン空き状況を見る</a>
    </div>
  </section>

  <!-- 今月の運動 -->
  <section class="card exercise-card">
    <span class="label">今月の運動</span>

    <div class="exercise">
      <span class="minutes" id="total-minutes">{{ total_exercise }}</span>
      <span class="unit">分</span>
    </div>

    <span class="exercise-span">記録をつける</span>

    <!-- ★ onsubmit で完全ガード -->
    <form method="post"
          action="{% url 'add_exercise_log' %}"
          class="exercise-form"
          id="exercise-form"
          onsubmit="return false;">
      {% csrf_token %}

      <label>
        日付
        <input type="date" name="date" id="exercise-date" readonly>
      </label>

      <label>
        運動時間（分）
        <input type="number" name="minutes" min="0" step="5" placeholder="例：30">
      </label>

      <button type="submit" class="btn primary">記録する</button>
    </form>

    <div class="plus-effect" id="plus-effect">+0分</div>
  </section>

</div>

<script>
const pins = document.querySelectorAll(".store-pin");
const routeLine = document.getElementById("route-line");
const map = document.getElementById("map");

const storeName = document.getElementById("store-name");
const storeDistance = document.getElementById("store-distance");
const storeAvailable = document.getElementById("store-available");

const form = document.getElementById("exercise-form");
const dateInput = document.getElementById("exercise-date");
const totalMinutesEl = document.getElementById("total-minutes");
const plusEffect = document.getElementById("plus-effect");

/* ---------- 店舗ピン ---------- */

const ROUTE_START = {
  gotanda: { x: 55, y: 118 },
  meguro:  { x: 50, y: 125 },
  osaki:   { x: 50, y: 135 },
};

pins.forEach(pin => {
  pin.addEventListener("click", () => {
    pins.forEach(p => p.classList.remove("selected"));
    pin.classList.add("selected");

    const mapRect = map.getBoundingClientRect();
    const pinRect = pin.getBoundingClientRect();

    let start = ROUTE_START.meguro;
    if (pin.classList.contains("gotanda")) start = ROUTE_START.gotanda;
    if (pin.classList.contains("meguro"))  start = ROUTE_START.meguro;
    if (pin.classList.contains("osaki"))   start = ROUTE_START.osaki;

    const startX = start.x;
    const startY = start.y;

    const endX = pinRect.left + pinRect.width / 2 - mapRect.left;
    const endY = pinRect.top + pinRect.height / 2 - mapRect.top;

    const midX = startX + (endX - startX) * 0.5;
    const midY = startY + (endY - startY) * 0.5 + 14;

    routeLine.setAttribute(
      "points",
      `${startX},${startY} ${midX},${midY} ${endX},${endY}`
    );

    routeLine.classList.remove("active");
    void routeLine.offsetWidth;
    routeLine.classList.add("active");

    storeName.textContent = pin.dataset.name;
    storeDistance.textContent =
      `${pin.dataset.distance}（${pin.dataset.meters}m）`;
    storeAvailable.textContent =
      `空き ${pin.dataset.available} 台`;
  });
});

/* ---------- 今日の日付 ---------- */

dateInput.value = new Date().toISOString().split("T")[0];

/* ---------- 運動記録（非同期・遷移なし） ---------- */

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  e.stopPropagation();

  const add = Number(form.minutes.value || 0);
  if (add <= 0) return;

  const formData = new FormData(form);

  const res = await fetch(form.action, {
    method: "POST",
    headers: {
      "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
    },
    body: formData,
  });

  const data = await res.json();
  if (!data.success) return;

  // 加算アニメーション
  plusEffect.textContent = `+${add}分`;
  plusEffect.classList.add("show");

  let current = Number(totalMinutesEl.textContent);
  let target = current + add;
  let step = Math.max(1, Math.floor(add / 40));

  const timer = setInterval(() => {
    current += step;
    if (current >= target) {
      current = target;
      clearInterval(timer);
      totalMinutesEl.textContent = current;
      plusEffect.classList.remove("show");
      form.reset();
      dateInput.value = new Date().toISOString().split("T")[0];
    } else {
      totalMinutesEl.textContent = current;
    }
  }, 20);
});
</script>

{% endblock %}